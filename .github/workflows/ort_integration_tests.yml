name: ONNX Runtime Integration Tests

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  macos_integration_test:
    runs-on: macos-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.29.0'
          channel: 'stable'

      - name: Enable macOS desktop support
        run: flutter config --enable-macos-desktop

      - name: Install dependencies
        run: |
          flutter pub get
          cd example
          flutter pub get

      - name: Verify model file exists
        run: |
          find . -name "addition_model.ort" || echo "Model not found!"
          ls -la example/assets/models || echo "Directory not found!"

      - name: Run integration tests on macOS
        run: |
          # Use the existing example app
          cd example
          
          # Run the integration test directly
          flutter test integration_test/onnxruntime_integration_test.dart -d macos 

  android_integration_test:
    runs-on: macos-13 # macOS runner needed for Android emulator

    steps:
      - uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.29.0'
          channel: 'stable'

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'adopt'
          java-version: '17'

      - name: Install dependencies
        run: |
          flutter pub get
          cd example
          flutter pub get

      - name: Verify model file exists
        run: |
          find . -name "addition_model.ort" || echo "Model not found!"
          ls -la example/assets/models || echo "Directory not found!"

      - name: Start Android emulator
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 26
          arch: x86_64
          target: google_apis
          profile: Nexus 6
          emulator-options: -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim -camera-back none
          script: |
            set -e # Exit immediately if a command exits with a non-zero status

            # Use the existing example app
            cd example
            
            # Verify that files exist
            echo "Checking integration test file"
            ls -la integration_test/ || echo "Integration test directory not found"
            
            # Use alternate method for Android: Make a custom app that runs the integration test
            echo "Creating integration test app entry point"
            cat > integration_test/app_test.dart << 'EOT'
            import 'package:flutter/material.dart';
            import 'package:flutter_test/flutter_test.dart';
            import 'package:integration_test/integration_test.dart';
            import 'onnxruntime_integration_test.dart' as test;
            
            void main() {
              IntegrationTestWidgetsFlutterBinding.ensureInitialized();
              test.main();
            }
            EOT
            
            # Create the driver
            mkdir -p test_driver
            echo 'import "package:integration_test/integration_test_driver.dart";
            
            Future<void> main() => integrationDriver();' > test_driver/integration_test.dart
            
            # Show connected devices
            flutter devices
            
            # Run with the driver
            flutter drive \
              --driver=test_driver/integration_test.dart \
              --target=integration_test/app_test.dart \
              -d android